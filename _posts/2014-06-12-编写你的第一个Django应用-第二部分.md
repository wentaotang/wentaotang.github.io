---
layout: post
title:  Django-第二部分
categories:
- Django
tags:
- Django
---

## 编写你的第一个Django应用，第二部分

这篇教程承接教程-1，我们继续Webpoll应用并重点关注Django的自动生成后端管理代码. 

```
**哲理** 
生成管理网站让你的员工和客户添加、修改、删除内容是一项单调乏味的工作，不需要很多的创造力。出于这个原因，Django根据模型自动化生成管理接口。  

Django是为新闻内容为主的网站服务而编写的，在“内容发布”和“公共网站”之间有很清晰的分离。网站管理人员使用该系统添加新闻、事件、体育等分等内容，然后发布到公共网站。为了解决这个问题，Django为网站管理员创建了一个统一的界面编辑内容。

管理网站并不是为网站游客使用的，而是为网站管理者服务的。
```


## 启动开发模式

Django管理网站是默认激活的，让我们启动开发模式并访问它。

回顾教程-1，我们是这样启动开发服务器的：

```python
python manage.py runserver
```

现在，打开web浏览器，输入[http://127.0.0.1:8000/admin](http://127.0.0.1:8000/admin),你应该可以看到如下的登录界面：

![登录](http://wentaotang.github.io/images/login.png) 

登录页面显示的是否是你本地语言，取决于你浏览器的设置和Django是否翻译了该语言。

```
** 如果你没有看到登录页面**

如果你没有看到一个登录页面而是一个类似下面的错误报告

> ImportError at /admin/
> cannot import name patterns
> ...

那么有可能就是您的DJango的版本不适合我这篇教程。你需要切换到旧教程或是新版的Django。
```

## 进入网站后台

现在尝试登录，你新建了一个超级账户在第一篇教程的时候，还记得吗？如果你没有创建或是忘记了密码，你可以另外创建一个.

假设我们在第一篇教程的时候忘记了创建超级账户或是忘记了密码，我们可以这么做：

1. 创建超级用户
   ： manage.py syncdb 在你第一次运行的时候就提示你创建一个超级账户，如果你想在以后再创建超级用户，你可以使用下面的命令：

    ```
    $ python manage.py createsuperuser --username=joe --email=joe@example.com
    ```
   
你将提示输入密码，你输入密码以后，用户就立即创建了。如果你没有输入--username 或者--email，它将提示你输入这些相应的值。

2.  创建密码
   ： Django没有存储用户模型的原始明文密码，仅存储了一个hash值。因此，不要试图直接操作用户的密码属性，这也是为什么使用帮助函数创建一个用户。

   为了改变一个用用户的密码，你有几个选择：

   manage.py changepassword username 提供了一种从命令行修改用户密码的方法。它将提示给指定的用户修改密码，必须输入2次密码。如果2次密码一致，那么密码就立即生效，如果你不提供指定的用户，系统将会尝试匹配当前系统用户并修改密码。

   你也可以通过编码的方式来修改密码，使用set_password():

   ```
   >>> from django.contrib.auth.models import User
   >>> u=User.objects.get(username__exact='john')
   >>> u.set_password('new password')
   >>> u.save()
   ```

   如果Django安装了admin模块，你也可以通过系统的页面修改用户密码。


进入系统以后，你可以看到如下也页面：

![main](http://wentaotang.github.io/images/main.png)

你应该看到一些可编辑的类型：组和用户。它们是有django.contrib.auth提供的，身份验证框架是Django提供的。

## 让poll app在后台可编辑

但是我们的poll app到哪里去了呢，在管理页面首页没有看到。

我们只需要干一件事：我们需要告诉admin，Poll对象有一个admin接口，你可以这样做，打开polls/admin.py 文件，如下这样编辑：

```
from django.contrib import admin
from polls.models import Poll

admin.site.register(Poll)
```

## 探索免费的管理功能

现在我们注册了Poll，Django知道它应该在管理首页。

![图片](http://wentaotang.github.io/images/20140612222106.png)

点击“Polls”，你将看到Polls列表页，你可以选择一条记录修改：(http://wentaotang.g)

![图片](http://wentaotang.github.io/images/edit.png)

注意事项：

- 这个表单是根据Poll模型自动生成的。
- 模型不同类型的字段对应HTML页面不同的元素，Django管理网站知道如何显示每种不同类型的字段。
- 每个DateTimeFiled都有个方便的javaScript快捷方式。日期有一个`今天`的快捷方式和一个弹出式日历，事件有一个`现在`的快捷方式和一个列出了常用时间选项的弹出式窗口

在页面底部还为你提供了几个选项：
 - 保存并新增另一个：保存你的修改，返回一个新增的页面。
 - 保存并继续编辑：保存你的修改并重新加载该页面
 - 保存：保存你的修改并返回到列表页面

如果“Date published” 的值与你在第一部分教程中创建的值不匹配，有可能是你忘记设置TIME_ZONE的值了，修改正确后并重新加载页面来确保修改正确。

分别点击`今天`和`现在`2个快捷方式修改Date Published的值，然后点击`保存并继续编辑`的按钮，然后再点击右上角的`历史`按钮，你将看到一个更改的清单页面，包含了修改的时间和修改人的姓名等信息。

## 自定义管理表单

花些时间感叹下吧，你没几行代码就拥有了这么多功能。通过admin.site.register(Poll)注册Poll模型，Django就能构造一个默认的表单。一般情况下，你想要自定义表单的外观和功能，这样的话，你需要在注册对象的时候告诉Django对应的配置。

让我们来看看给何在编辑表单上给字段排序。修改polls/admin.py文件，把admin.site.register(poll)提行替换成如下所示的代码：

```python
from django.contrib import admin
from polls.models import Poll

class PollAdmin(admin.ModelAdmin):
    fields=['pub_date','question']

admin.site.register(Poll,PollAdmin)
```

你遵循这个模式：创建一个模型的管理对象，将它作为 admin.site.register() 方法的第二个参数传入 – 当你需要为一个对象做管理界面配置的时候。

上面特定的修改将使“Publication date” 字段在 “Question” 字段之前，如下所示：

![图片](htttp://wentaotang.github.io/images/20140614181422.png)

仅有2个字段不会令你影响深刻，但是对于有许多字段的管理表单时，选择一个直观的排序方式是一个非常重要的细节。

说到表单的字段，你可能想将表单中的字段分割成 fieldsets；

```python
from django.contrib import admin
from polls.models import Poll

class PollAdmin(admin.ModelAdmin):
    fieldsets=[
        (None,{"fields":['question']}),
        ('Date information',{"fields":['pub_date']}),
    ]

admin.site.register(Poll,PollAdmin)
```

在fieldsets中，每个tuple中的第一个元素就是fieldset的标题，这就是我们表单现在的样子：

![图片](http://wentaotang.github.io/images/20140614182753.png)

你也可以为每个fieldset指定html样式类，Django提供了一个"collapse"的样式类用于显示初始的时候是收缩的，当你有一个包含一些不常用的长窗体是这是非常有用的。

```python
class PollAdmin(admin.ModelAdmin):
    fieldsets = [
        (None,               {'fields': ['question']}),
        ('Date information', {'fields': ['pub_date'], 'classes': ['collapse']}),
    ]
```

修改后的界面如下所示：

![图片](http://wentaotang.github.io/images/20140614183437.png)
